#!/bin/bash

#set -o xtrace
set -e
export PYTHONPATH=`pwd`/src/main/python

mkdir target

################
echo -- HELP
################
#ofexport | sed -e 's/^Version: [0-9].*/Version: XXX XXX/' > src/test/data/help.txt
ofexport | sed -e 's/^Version: [0-9].*/Version: XXX XXX/' > target/help.txt
diff src/test/data/help.txt target/help.txt


#build-scripts/dump-test-data --open -o src/test/data/db-1.json

################
echo FORMAT TESTS - Project
################

for FMT in taskpaper md html opml ft json; do

    ################
    echo -- $FMT
    ################
    #ofexport -i src/test/data/db-1.json -o src/test/data/db-1.$FMT
    ofexport -i src/test/data/db-1.json -o target/db-1.$FMT
    diff src/test/data/db-1.$FMT target/db-1.$FMT

done

################
echo FORMAT TESTS - Context
################

for FMT in taskpaper md html opml ft json; do

    ################
    echo -- $FMT
    ################
    #ofexport -i src/test/data/db-1.json -C -o src/test/data/db-1-C.$FMT
    ofexport -i src/test/data/db-1.json -C -o target/db-1-C.$FMT
    diff src/test/data/db-1-C.$FMT target/db-1-C.$FMT

done

################
echo FILTER TESTS
################

################
echo -- Folder
################
TEST=f1
#ofexport -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Folder) and (name="Sub Folder 1")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Folder) and (name="Sub Folder 1")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=f2
#ofexport -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Folder) and (name="Sub Folder 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Folder) and (name="Sub Folder 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=f3
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Folder) and (name=".*Folder 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Folder) and (name="Sub Folder 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=f4
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -E -e '(type=Folder) and (name=".*Folder 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -E -e '(type=Folder) and (name=".*Folder 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

################
echo -- Project
################
TEST=p1
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Project) and (name="F1 Project 1")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Project) and (name="F1 Project 1")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=p2
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Project) and (name="F1 Project 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Project) and (name="F1 Project 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=p3
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Project) and (name=".*1 Project 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Project) and (name=".*1 Project 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=p4
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -E -e '(type=Project) and (name=".*1 Project 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -E -e '(type=Project) and (name=".*1 Project 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

################
echo -- Task
################
TEST=t1
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Task) and (name="task F1 P1 1")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Task) and (name="task F1 P1 1")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=t2
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Task) and (name="task F1 P1 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Task) and (name="task F1 P1 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=t3
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -e '(type=Task) and (name=".*sk F1 P1 1")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -e '(type=Task) and (name=".*sk F1 P1 1")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=t4
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -E -e '(type=Task) and (name="task F1 P1 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -E -e '(type=Task) and (name="task F1 P1 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper


################
echo -- Context
################
TEST=c1
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -C -e '(type=Context) and (name="Context 1")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -C -e '(type=Context) and (name="Context 1")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=c2
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -C -e '(type=Context) and (name="Context 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -C -e '(type=Context) and (name="Context 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=c3
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -C -e '(type=Context) and (name="Co.*ext 1")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -C -e '(type=Context) and (name="Co.*ext 1")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

TEST=c4
#ofexport --open -i src/test/data/db-1.json -o src/test/data/db-1-$TEST.taskpaper -C -E -e '(type=Context) and (name="Context 2")'
ofexport  -i src/test/data/db-1.json -o target/db-1-$TEST.taskpaper -C -E -e '(type=Context) and (name="Context 2")'
diff src/test/data/db-1-$TEST.taskpaper target/db-1-$TEST.taskpaper

VERSION=`ofexport | grep Version`
echo '###############################################################################'
echo "PASSED UNIT TESTS $VERSION"
echo '###############################################################################'


